#!/bin/bash

set -e

. pk-common

on_exit() { rm -f "$tmp_list"; }
trap 'on_exit' EXIT

declare name="$1"
declare dir="$2"

declare list="$dir/list/$name.list"
declare build_dir="$dir/"`pk-root-dir "$dir"`

declare from2=${MINGW_PATH2//\//\\\/}
declare from=${MINGW_PATH//\//\\\/}
declare to=${build_dir//\//\\\/}


# extract package removing mingw prefix of filenames
tmp_list=`mktemp`
tar vxj --transform="s/$from2/./" --show-transformed-names -f "$INSTALL_PATH/$name.tar.bz2" \
  -C "$build_dir" --wildcards "$MINGW_PATH2/*" > "$tmp_list"

cd "$build_dir"

# rm pure directory entries
comm -23 <(sort "$tmp_list") <(find . -type d | sort) > "$list"

#fix .la and .pc files
grep -l "$MINGW_PATH" lib/pkgconfig/*.pc /lib/*.la | while read file
do
sed -i -re "s/$from/$to/g" $file
done

#!/bin/bash

. pk-common

declare -A names
names["$MIRROR_MAIN"]="MAIN"
names["$MIRROR_PORTS"]="PORTS"
tmp_list=`pk-make-tmp`
for mirror in "$MIRROR_MAIN" "$MIRROR_PORTS"
do
  echo "Update ${names[$mirror]} list"
  curl -# "$mirror/setup.bz2" | bzcat 2>/dev/null >"$tmp_list"
  # add tmp output to save list in case of download errors
  cp "$tmp_list" "${url_to_file[$mirror]}"
done

cd "$INSTALL_PATH"

clean=1

# Update packages
for pkg in mingw-*
do
  desc="$pkg/desc"
  ver=`cat "$desc" | pk-print-ver`
  file="$pkg/$pkg-$ver.tar.bz2"

  tmp_deps=`pk-make-tmp`

  # check package version
  ver2=`pk-find-desc "$pkg" | pk-print-ver`
  [ "$ver2" == "$ver" ] && continue

  echo "updating $pkg  $ver -> $ver2"
  pk-setup-package "$pkg"
  rm "$file"

  # check for new deps
  pk-make-dep-list2 "$pkg" pk-find-desc pk-setup-status > "$tmp_deps"

  cat "$tmp_deps" | while read pkg_dep
  do
    echo "Setup $pkg_dep as dependency for $pkg"
    pk-setup-package "$pkg_dep"
  done

  clean=0
done

[ "$clean" -eq 1 ] && echo "All packages are up-to-date"

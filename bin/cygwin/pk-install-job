#!/bin/bash

set -e

. pk-common

on_exit()
{
  rm -rf "$tmp_unpack"
  rm -f "$tmp_files"
  rm -f "$tmp_clash"
}
trap 'on_exit' EXIT

PACKAGE_NAME="$1"
PACKAGE_FILE="$INSTALL_PATH/$PACKAGE_NAME.tar.bz2"
LIST_FILE="$LIST_DIR/$PACKAGE_NAME.list"

# check there would be no filenames clashes
tmp_files=`mktemp`
tmp_clash=`mktemp`
tar tjf "$PACKAGE_FILE" > "$tmp_files"
MINGW_PATH2_SED=${MINGW_PATH2//\//\\\/}
sed -ri -e "s/$MINGW_PATH2_SED/\./" "$tmp_files"
for file in $LIST_DIR/*
do
  # set intersection
  comm -12 <(sort "$tmp_files") <(sort "$file") > "$tmp_clash"
  [ -s "$tmp_clash" ] && {
    file1=${file%.list}
    file2=${file1##*/}
    echo "ERROR: package $PACKAGE_NAME clash with $file2"
    echo "       clashed files are:"
    cat "$tmp_clash"
    exit 1
  }
done

echo "install $PACKAGE_NAME"

# extract package to tmp dir
tmp_unpack=`mktemp -d`
tar xjf "$PACKAGE_FILE" -C "$tmp_unpack"

# cd to mingw path in tmp dir
cd "$tmp_unpack/$MINGW_PATH"

# create file list
find . -type f > "$LIST_FILE"

# mv package to build dir
tar c . | tar x -C "$BUILD_PATH"

#fix .la and .pc files
shopt -s nullglob
MINGW_PATH_SED=${MINGW_PATH//\//\\\/}
BUILD_PATH_SED=${BUILD_PATH//\//\\\/}
grep -l "$MINGW_PATH" "$BUILD_PATH"/lib/pkgconfig/*.pc "$BUILD_PATH"/lib/*.la | while read file
do
  sed -i -re "s/$MINGW_PATH_SED/$BUILD_PATH_SED/g" $file
done

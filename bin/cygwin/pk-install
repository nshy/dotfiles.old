#!/bin/bash

set -e

. pk-common

on_exit()
{
  rm -f "$tmp_deps"
}
trap 'on_exit' EXIT

package="$1"
dir=`pk-build-dir "$2"`

echo "Target dir is $dir"

[ $dir" != /build" ] && pk-create-local-dirs "$dir"

[ -z "$package" ] && { echo "ERROR: package not specified"; exit 1; }
name=`pk-find-fun "$package" "$INSTALL_PATH" "tar.bz2"`

tmp_deps=`mktemp`
pk-check-installed "$name" "$dir"
pk-make-dep-list "$name" "$dir" > "$tmp_deps"
cat "$tmp_deps" | while read name
do
  file="$INSTALL_PATH/$name.tar.bz2"
  pk-check-clash "$name" "$dir"
  echo "install $name"
  pk-extract "$name" "$dir"
  [ "$dir" != "/build" ] && cp "$INSTALL_PATH/$name.tar.bz2" "$dir/packages"
done

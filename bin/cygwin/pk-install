#!/bin/bash

set -e

. pk-common

on_exit()
{
  rm -f "$tmp_deps"
}
trap 'on_exit' EXIT

PACKAGE="$1"

[ -z "$PACKAGE" ] && { echo "ERROR: package not specified"; exit 1; }

PACKAGE_NAME=`pk-find-fun "$PACKAGE" "$INSTALL_PATH" "tar.bz2"`

# check if package already installed
[ -f "$LIST_DIR/$PACKAGE_NAME.list" ] && { echo "$PACKAGE_NAME is already installed"; exit 0; };

# make dep list
cd "$INSTALL_PATH"
tmp_deps=`mktemp`
add_deps()
{
  declare deps file

  deps=`grep 'requires' "$1.desc"`
  deps=${deps#requires:}

  for pack in $deps
  do
    grep "$pack" "$MINGW_BASE" >&/dev/null && continue
    add_deps `pk-find-fun "$pack" "$INSTALL_PATH" "desc"`
  done

  [ -f "$LIST_DIR/$1.list" ] && continue
  echo "$1" >> "$tmp_deps"
}
add_deps "$PACKAGE_NAME"

# find uniq lines without messing with sort
awk '!seen[$0]++' "$tmp_deps" | while read name
do
  pk-install-job "$name"
done

#!/bin/bash

set -e

. pk-common

on_exit()
{
  rm -rf "$tmp_files"
}

name="$1"
desc="$2"

[ -z "$name" ] && { echo "ERROR: package not specified"; exit 1; }
[ -z "$desc" ] && { echo "ERROR: description file not specified"; exit 1; }
[ -f "$desc" ] || { echo "ERROR: description file not exits"; exit 1; }
grep 'requires:' "$desc" >&/dev/null || { echo "ERROR: no deps in description"; exit 1; }

trap 'on_exit' EXIT

desc_file=`readlink -f $desc`

cd "$BUILD_PATH"

tmp_files=`mktemp`
pk-new > "$tmp_files"

[ `stat -c %s "$tmp_files"` = '0' ] && { echo "WARNING: no new files"; exit 0; }

echo "Make package $name"

cd "$BUILD_PATH"
tar -cjf "$INSTALL_PATH"/"$name".tar.bz2 -T "$tmp_files" \
  --transform="s,^.,$MINGW_PATH2,"
cp "$desc_file" "$INSTALL_PATH"/"$name".desc
cp "$tmp_files" "$LIST_DIR"/"$name".list

#!/bin/bash

set -e

. pk-common

on_exit()
{
  rm -rf "$tmp_files"
}

PACKAGE="$1"
DESC="$2"

[ -z "$PACKAGE" ] && { echo "ERROR: package not specified"; exit 1; }
[ -z "$DESC" ] && { echo "ERROR: description file not specified"; exit 1; }
[ -f "$DESC" ] || { echo "ERROR: description file not exits"; exit 1; }
grep 'requires:' "$DESC" >&/dev/null || { echo "ERROR: no deps in description"; exit 1; }

trap 'on_exit' EXIT

DESC_FILE=`readlink -f $DESC`

cd "$BUILD_PATH"

tmp_files=`mktemp`
pk-new > "$tmp_files"

[ `stat -c %s "$tmp_files"` = '0' ] && { echo "WARNING: no new files"; exit 0; }

echo "Make package $PACKAGE"

cd "$BUILD_PATH"
tar -cjf "$INSTALL_PATH"/"$PACKAGE".tar.bz2 -T "$tmp_files" \
  --transform="s,^.,$MINGW_PATH2,"
cp "$DESC_FILE" "$INSTALL_PATH"/"$PACKAGE".desc
cp "$tmp_files" "$LIST_DIR"/"$PACKAGE".list

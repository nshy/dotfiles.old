#!/bin/bash

INSTALL_PATH="/packages"
MINGW_PATH="/usr/i686-pc-mingw32/sys-root/mingw"
MINGW_PATH2="usr/i686-pc-mingw32/sys-root/mingw"
MINGW_BASE=~/bin/cygwin/pk-mingw-list

MIRROR_PORTS="ftp://ftp.cygwinports.org/pub/cygwinports"
MIRROR_MAIN="http://linux.rz.ruhr-uni-bochum.de/download/cygwin"
PK_TMP_FILES=`mktemp`

shopt -s nullglob
trap pk-on-exit EXIT
set -e

pk-make-tmp()
{
  declare f=`mktemp`
  echo "$f" >> "$PK_TMP_FILES"
  echo "$f"
}

pk-on-exit()
{
  rm -f `cat "$PK_TMP_FILES"`
  rm "$PK_TMP_FILES"
}

pk-mirror-dir()
{
  echo "$1" | sed -e "s/:/%3a/g" -e "s:/:%2f:g"
}

pk-create-local-dirs()
{
    [ -d list ] || mkdir list
    [ -d libs ] || mkdir libs
    [ -d packages ] || mkdir packages
}

pk-find-desc()
{
  declare pkg="$1"
  set +e
  # find package description
  declare mirror
  for mirror in "$MIRROR_MAIN" "$MIRROR_PORTS"
  do
    declare dir="/setup/`pk-mirror-dir "$mirror"`"
    tmp_script=`pk-make-tmp`
    cat >"$tmp_script" - <<'CODE'
      BEGIN {
        RS = "\n\n@ "
        FS = "\n"
      }
      {
        if ($1 == package) {
          desc = $0
          px++
        }
      }
      END {
        if (px == 1 && desc != "")
          print desc
        else
          exit 1
      }
CODE
  # cat "$tmp_script" >&2
  awk -v package="$pkg" -f "$tmp_script" "$dir/setup.ini" && {
    set -e
    pk_find_desc_mirror="$mirror"
    return
  }
  done
  set -e
  echo "ERROR: $pkg not found in mirrors" >&2
  exit 1
}

pk-setup-status()
{
  [ -d "$INSTALL_PATH/"$1 ]
}

pk-install-status()
{
  [ -f "$pk_list_dir/$1.list" ]
}

pk-setup-package()
{
  declare pkg="$1"
  declare tmp_desc=`pk-make-tmp`
  declare tmp_deps=`pk-make-tmp`

  # find package description
  pk-find-desc "$pkg" > "$tmp_desc"
  declare ver2=`awk '/^version: / { print $2; exit }' "$tmp_desc"`
  declare file2="$pkg/$pkg-$ver2.tar.bz2"
  declare desc2="$pkg/desc"
  declare path2=`awk '/^install: / { print $2; exit }' "$tmp_desc"`

  [ -d "$pkg" ] || mkdir "$pkg"
  # download new version
  cp "../mirror/$file2" "$file2"
  # wget -q -O "$file2" "$pk_find_desc_mirror/$path2"
  cp "$tmp_desc" "$desc2"

  # check the md5
  declare dig1=`cat "$tmp_desc" | awk '/^install: / { print $4; exit }'`
  declare dig2=`md5sum $file2 | awk '{print $1}'`
  [ "$dig1" != "$dig2" ] && {
    echo "ERROR: md5 sum did not match"
    rm "$file2"
    rm "$desc2"
    exit 1
  }

  return 0
}

pk-print-deps()
{
  declare deps=`grep 'requires' -`
  declare deps=${deps#requires:}
  echo "$deps"
}

pk-print-ver()
{
  awk '/^version: / { print $2; exit }' -
}

pk-make-dep-list2()
{
  declare pkg="$1"
  declare find_fun="$2"
  declare check_fun="$3"

  declare tmp_deps=`pk-make-tmp`

  cd "$INSTALL_PATH"
  add_deps()
  {
    declare dep
    for dep in `"$find_fun" "$1" | pk-print-deps`
    do
      # echo "$dep" >&2
      grep "$dep" "$MINGW_BASE" >&/dev/null && continue
      add_deps "$dep"
    done

    "$check_fun" "$1" && return
    echo "$1" >> "$tmp_deps"
  }
  add_deps "$pkg"

  # find uniq lines without messing with sort
  awk '!seen[$0]++' "$tmp_deps"
}

pk-check-package()
{
  declare pkg="$1"
  declare tab="$2"

  declare file="$pkg/vers"
  declare tab2="$tab  "

  declare tmp_diff=`pk-make-tmp`

  declare pkg v1
  cat "$file" | while read pkg v1
  do
    if [[ "$pkg" =~ ^my- ]]
    then
      pk-check-package "$pkg" "$tab2" >> "$tmp_diff"
    else
      declare v2=`pk-find-desc "$pkg" | pk-print-ver`
      [ "$v2" == "$v1" ] && continue
      echo "$tab2$pkg $v1 -> $v2" >> "$tmp_diff"
    fi
  done
  [ -s "$tmp_diff" ] && {
    echo "$tab$pkg is out-of-date, diff:"
    cat "$tmp_diff"
    return 1
  }
  return 0
}

pk-local-desc()
{
  cat "$INSTALL_PATH/$1/desc"
}

pk-pkg-to-tar()
{
  declare ver=`pk-local-desc "$name" | pk-print-ver`
  echo "$1-$ver.tar.bz2"
}

pk-local-tar()
{
  declare ver=`pk-local-desc "$name" | pk-print-ver`
  echo "$1/$1-$ver.tar.bz2"
}

pk-check-clash2()
{
  declare name="$1"
  declare dir="$2"

  declare build_dir="$dir/libs"
  declare file=`pk-local-tar "$name"`

  declare tmp_clash=`pk-make-tmp`
  declare tmp_files=`pk-make-tmp`

  tar tj --transform="s,$MINGW_PATH2,.," --show-transformed-names \
    -f "$INSTALL_PATH/$file" > "$tmp_files"

  for name2 in $dir/list/*
  do
    # set intersection
    comm -12 <(sort "$tmp_files") <(sort "$name2") > "$tmp_clash"
    [ -s "$tmp_clash" ] && {
      echo "ERROR: package $name clash with $name2"
      echo "       clashed files are:"
      cat "$tmp_clash"
      exit 1
    }
  done
  return 0
}

pk-tar-file()
{
  declare name="$1"
  declare dir="$2"
  declare ver=`cat "$dir/$name/desc" | pk-print-ver`
  echo "$dir/$name/$name-$ver.tar.bz2"
}

pk-extract2()
{
  declare name="$1"
  declare dir="$2"
  declare pack_dir="$3"

  declare list="$dir/list/$name.list"
  declare file=`pk-tar-file "$name" "$pack_dir"`
  declare build_dir="$dir/libs"

  pushd "$build_dir" >/dev/null

  # extract package removing mingw prefix of filenames
  declare tmp_list=`pk-make-tmp`
  tar vxj --transform="s,$MINGW_PATH2,.," --show-transformed-names -f "$file" \
    --wildcards "$MINGW_PATH2/*" > "$tmp_list" 2>/dev/null || echo >/dev/null # nop

  # rm pure directory entries
  comm -23 <(sort "$tmp_list") <(find . -type d | sort) > "$list"

  #fix .la and .pc files
  declare file
  grep -l "$MINGW_PATH" lib/pkgconfig/*.pc /lib/*.la | while read file
  do
    sed -i -re "s,$MINGW_PATH,$build_dir,g" $file
  done

  popd >/dev/null
}

pk-create-vers()
{
  declare name="$1"

  declare dep
  for dep in `cat "$INSTALL_PATH/$1/desc" | pk-print-deps`
  do
    declare v=`cat "$INSTALL_PATH/$dep/desc" | pk-print-ver`
    echo "$dep" "$v"
  done
}

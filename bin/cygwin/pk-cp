#!/bin/bash

set -e

PACKAGE=$1

# [ -z "$PACKAGE" ] && PACKAGE="mingw-gtk2.0"

[ -z "$PACKAGE" ] && {
  echo "ERROR: package not specified"
  exit 1
}

# package is system-wide
cygcheck -dc | grep "$PACKAGE" >&/dev/null && exit 0;

SETUP_PATH1="/setup/ftp%3a%2f%2fftp.cygwinports.org%2fpub%2fcygwinports/release"
SETUP_PATH2="/setup/http%3a%2f%2flinux.rz.ruhr-uni-bochum.de%2fdownload%2fcygwin/release"
INSTALL_PATH="/build/package"

SETUP_PATH=
[ -d "$SETUP_PATH1/$PACKAGE" ] && SETUP_PATH="$SETUP_PATH1"
[ -z "$SETUP_PATH" ] && [ -d "$SETUP_PATH2/$PACKAGE" ] && SETUP_PATH="$SETUP_PATH2"
[ -z "$SETUP_PATH" ] && {
  echo "ERROR: package $PACKAGE not found"
  exit 1
}

PACKAGE_FILE=("$SETUP_PATH/$PACKAGE/$PACKAGE"*)
DESC_FILE="$SETUP_PATH/$PACKAGE/desc"
PACKAGE_NAME=${PACKAGE_FILE##*/}

deps=`grep 'requires' $DESC_FILE`
deps=${deps#requires: }
for pack in $deps
do
  pk-cp "$pack"
done

# package already installed
[ -f "$INSTALL_PATH"/"$PACKAGE_NAME" ] && exit 0;

echo "setup $PACKAGE_NAME"

[ -d "$INSTALL_PATH" ] || mkdir -p "$INSTALL_PATH"
# copy package files
DESC_NAME=${PACKAGE_NAME%.tar.bz2}.desc
cp "$PACKAGE_FILE" "$INSTALL_PATH"
cp "$DESC_FILE" "$INSTALL_PATH/$DESC_NAME"
